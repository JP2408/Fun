Option Explicit

Sub BuildFinalList()
    Const SRC_PATH As String = "C:\Your\Folder\Path\"        '<<< CHANGE THIS
    Const SRC_FILE As String = "YourSourceFile.xlsx"         '<<< CHANGE THIS
    Const RESULT_FILE As String = "Final List.xlsx"
    
    Dim srcWb As Workbook
    Dim srcWs As Worksheet
    Dim finalWb As Workbook
    Dim finalWs As Worksheet
    Dim tjWs As Worksheet
    
    Dim lastRow As Long
    Dim lastRowP As Long
    Dim dataStartRow As Long
    Dim savePath As String
    Dim rngVisible As Range
    Dim firstChunkEnd As Long
    
    On Error GoTo CleanFail
    
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False
    
    '--- Open source workbook
    Set srcWb = Workbooks.Open(Filename:=SRC_PATH & SRC_FILE)
    Set srcWs = srcWb.Worksheets(1) '<<< change if needed, e.g. srcWb.Worksheets("SheetName")
    
    '--- Remove duplicates based on Column G (7th column) in A:P
    lastRow = srcWs.Cells(srcWs.Rows.Count, "G").End(xlUp).Row
    If lastRow < 2 Then GoTo AfterSourceProcessing ' no data beyond header
    
    With srcWs.Range("A1:P" & lastRow)
        .RemoveDuplicates Columns:=7, Header:=xlYes
    End With
    
    'Recalculate last row after duplicate removal
    lastRow = srcWs.Cells(srcWs.Rows.Count, "G").End(xlUp).Row
    
AfterSourceProcessing:
    '--- Create new workbook and copy A:P
    Set finalWb = Workbooks.Add(xlWBATWorksheet)
    Set finalWs = finalWb.Worksheets(1)
    finalWs.Name = "Final List"
    
    If lastRow >= 1 Then
        srcWs.Range("A1:P" & lastRow).Copy
        With finalWs.Range("A1")
            .PasteSpecial xlPasteValues
        End With
        Application.CutCopyMode = False
    End If
    
    '--- Close source file without saving
    srcWb.Close SaveChanges:=False
    
    '--- Filter Column P = "N" and delete those rows
    With finalWs
        lastRowP = .Cells(.Rows.Count, "P").End(xlUp).Row
        If lastRowP >= 2 Then
            .Range("A1:P" & lastRowP).AutoFilter Field:=16, Criteria1:="N"
            
            On Error Resume Next
            Set rngVisible = .Range("A2:P" & lastRowP).SpecialCells(xlCellTypeVisible)
            On Error GoTo 0
            
            If Not rngVisible Is Nothing Then
                rngVisible.EntireRow.Delete
                Set rngVisible = Nothing
            End If
            
            .AutoFilterMode = False
        End If
    End With
    
    '--- Recalculate lastRow after deletions
    With finalWs
        lastRow = .Cells(.Rows.Count, "G").End(xlUp).Row
    End With
    
    '--- Add Sheet2 for TEXTJOIN output
    Set tjWs = finalWb.Worksheets.Add(After:=finalWs)
    'Keep default name ("Sheet2") as requested
    
    dataStartRow = 2 'assuming headers in row 1 in Final List
    
    If lastRow >= dataStartRow Then
        '===== Column G joins =====
        'Row 1: Column G-1 (first up to 2000 records)
        tjWs.Range("A1").Value = "Column G-1"
        firstChunkEnd = Application.WorksheetFunction.Min(lastRow, dataStartRow + 2000 - 1)
        tjWs.Range("B1").Formula = _
            "=TEXTJOIN("","",TRUE,'Final List'!G" & dataStartRow & ":G" & firstChunkEnd & ")"
        
        'Row 2: Column G-2 (remaining records, if any)
        If lastRow > firstChunkEnd Then
            tjWs.Range("A2").Value = "Column G-2"
            tjWs.Range("B2").Formula = _
                "=TEXTJOIN("","",TRUE,'Final List'!G" & (firstChunkEnd + 1) & ":G" & lastRow & ")"
        End If
        
        '===== Column I joins =====
        'Row 3: Column I-1 (first up to 2000 records)
        tjWs.Range("A3").Value = "Column I-1"
        firstChunkEnd = Application.WorksheetFunction.Min(lastRow, dataStartRow + 2000 - 1)
        tjWs.Range("B3").Formula = _
            "=TEXTJOIN("","",TRUE,'Final List'!I" & dataStartRow & ":I" & firstChunkEnd & ")"
        
        'Row 4: Column I-2 (remaining records, if any)
        If lastRow > firstChunkEnd Then
            tjWs.Range("A4").Value = "Column I-2"
            tjWs.Range("B4").Formula = _
                "=TEXTJOIN("","",TRUE,'Final List'!I" & (firstChunkEnd + 1) & ":I" & lastRow & ")"
        End If
        
        'Convert formulas and labels to values
        With tjWs.Range("A1:B4")
            .Value = .Value
        End With
    End If
    
    '--- Save Final List workbook in same folder
    savePath = SRC_PATH & RESULT_FILE
    finalWb.SaveAs Filename:=savePath, FileFormat:=xlOpenXMLWorkbook
    
CleanExit:
    Application.DisplayAlerts = True
    Application.ScreenUpdating = True
    Exit Sub
    
CleanFail:
    MsgBox "Error: " & Err.Number & " - " & Err.Description, vbCritical, "BuildFinalList"
    Resume CleanExit
End Sub