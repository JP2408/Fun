Option Explicit

Sub BuildFinalList()
    Const SRC_PATH As String = "C:\Your\Folder\Path\"        '<<< CHANGE THIS
    Const SRC_FILE As String = "YourSourceFile.xlsx"         '<<< CHANGE THIS
    Const RESULT_FILE As String = "Final List.xlsx"
    
    Dim srcWb As Workbook
    Dim srcWs As Worksheet
    Dim finalWb As Workbook
    Dim finalWs As Worksheet
    Dim tjWs As Worksheet
    
    Dim lastRow As Long
    Dim lastRowP As Long
    Dim dataStartRow As Long
    Dim dataRowCount As Long
    Dim chunkSize As Long
    Dim chunkCount As Long
    Dim i As Long
    Dim firstRow As Long
    Dim lastRowChunk As Long
    Dim rngVisible As Range
    Dim savePath As String
    
    On Error GoTo CleanFail
    
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False
    
    '--- Open source workbook
    Set srcWb = Workbooks.Open(Filename:=SRC_PATH & SRC_FILE)
    Set srcWs = srcWb.Worksheets(1) '<<< change if needed (e.g. srcWb.Worksheets("SheetName"))
    
    '--- Remove duplicates based on Column G (7th column) in A:P
    lastRow = srcWs.Cells(srcWs.Rows.Count, "G").End(xlUp).Row
    If lastRow < 2 Then GoTo AfterSourceProcessing 'no data
    
    With srcWs.Range("A1:P" & lastRow)
        .RemoveDuplicates Columns:=7, Header:=xlYes
    End With
    
    'Recalculate last row after duplicate removal
    lastRow = srcWs.Cells(srcWs.Rows.Count, "G").End(xlUp).Row
    
AfterSourceProcessing:
    '--- Create new workbook and copy A:P
    Set finalWb = Workbooks.Add(xlWBATWorksheet)
    Set finalWs = finalWb.Worksheets(1)
    finalWs.Name = "Final List"
    
    If lastRow >= 1 Then
        srcWs.Range("A1:P" & lastRow).Copy
        With finalWs.Range("A1")
            .PasteSpecial xlPasteValues
        End With
        Application.CutCopyMode = False
    End If
    
    '--- Close source file without saving
    srcWb.Close SaveChanges:=False
    
    '--- Filter Column P = "N" and delete those rows
    With finalWs
        lastRowP = .Cells(.Rows.Count, "P").End(xlUp).Row
        If lastRowP >= 2 Then
            .Range("A1:P" & lastRowP).AutoFilter Field:=16, Criteria1:="N"
            
            On Error Resume Next
            Set rngVisible = .Range("A2:P" & lastRowP).SpecialCells(xlCellTypeVisible)
            On Error GoTo 0
            
            If Not rngVisible Is Nothing Then
                rngVisible.EntireRow.Delete
                Set rngVisible = Nothing
            End If
            
            .AutoFilterMode = False
        End If
    End With
    
    '--- Recalculate lastRow after deletions
    With finalWs
        lastRow = .Cells(.Rows.Count, "G").End(xlUp).Row
    End With
    
    '--- Add Sheet2 for TEXTJOIN output
    Set tjWs = finalWb.Worksheets.Add(After:=finalWs)
    'Do NOT rename so it stays "Sheet2" as requested
    
    '--- TEXTJOIN on Column G (A column in Sheet2) and Column I (B column in Sheet2)
    dataStartRow = 2 'assuming headers in row 1
    If lastRow >= dataStartRow Then
        dataRowCount = lastRow - dataStartRow + 1
        chunkSize = 2000
        
        chunkCount = (dataRowCount + chunkSize - 1) \ chunkSize 'ceiling
        
        For i = 0 To chunkCount - 1
            firstRow = dataStartRow + i * chunkSize
            lastRowChunk = firstRow + chunkSize - 1
            If lastRowChunk > lastRow Then lastRowChunk = lastRow
            
            ' Column G join in Sheet2!A
            tjWs.Cells(i + 1, "A").Formula = _
                "=TEXTJOIN("","",TRUE,'Final List'!G" & firstRow & ":G" & lastRowChunk & ")"
            
            ' Column I join in Sheet2!B
            tjWs.Cells(i + 1, "B").Formula = _
                "=TEXTJOIN("","",TRUE,'Final List'!I" & firstRow & ":I" & lastRowChunk & ")"
        Next i
        
        'Convert formulas to values
        With tjWs.Range("A1:B" & chunkCount)
            .Value = .Value
        End With
    End If
    
    '--- Save Final List workbook in same folder
    savePath = SRC_PATH & RESULT_FILE
    finalWb.SaveAs Filename:=savePath, FileFormat:=xlOpenXMLWorkbook
    
CleanExit:
    Application.DisplayAlerts = True
    Application.ScreenUpdating = True
    Exit Sub
    
CleanFail:
    'basic error cleanup
    MsgBox "Error: " & Err.Number & " - " & Err.Description, vbCritical, "BuildFinalList"
    Resume CleanExit
End Sub